{"flow":{"onboarding":{"$contentActions":[{"input":{"bypass":false,"$cardContent":{"document":{"id":"a5f855b2-7344-44ad-bf8b-75bccd63d288","type":"text/plain","content":"Inicio"},"editable":false,"deletable":false,"position":"right"},"$invalid":false,"variable":"Inicio"},"$invalid":false}],"$conditionOutputs":[{"stateId":"desk:b9c4c16e-12aa-4c01-a6f3-ccda7e3fe57e","$connId":"con_3","$id":"4c6b3d4e-49f8-4e8a-a55c-840600014557","conditions":[{"source":"input","comparison":"exists","values":[]}],"$invalid":false}],"$enteringCustomActions":[],"$leavingCustomActions":[{"$id":"3cffad3f-a425-4f3d-af14-4a70650ca397","type":"ExecuteScript","$title":"Get phoneNumber","$invalid":false,"settings":{"function":"run","source":"/**\n            * All input variables needs to be passed as function param;\n            * Objects received as param needs to be parsed. Ex.: JSON.parse(inputVariable1);\n            * Objects returned needs to be stringfied. Ex.: JSON.stringify(inputVariable1);\n            **/\n            function run(originator) {\n                return originator.split('@')[0];\n            }","inputVariables":["tunnel.originator"],"outputVariable":"completePhoneNumber","LocalTimeZoneEnabled":false},"conditions":[]},{"$id":"480b9d42-dd04-46a9-ba54-6e49d130bbf5","type":"ProcessHttp","$title":"Get alternativeAccount","$invalid":false,"settings":{"headers":{"Authorization":"{{config.routerKey}}","Content-Type":"application/json"},"method":"POST","body":"{  \n  \"id\": \"{{random.guid}}\",\n  \"to\": \"postmaster@wa.gw.msging.net\",\n  \"method\": \"get\",\n  \"uri\": \"lime://wa.gw.msging.net/accounts/+{{completePhoneNumber}}\"\n}","uri":"{{config.commands}}","responseStatusVariable":"acStatus","responseBodyVariable":"acReturn"},"conditions":[]},{"$id":"a434f59b-2e93-4774-9ac0-fef629fa5228","type":"ExecuteScript","$title":"GET WhatsApp Account","$invalid":false,"settings":{"function":"run","source":"\nfunction run(acReturn) {\n    acReturn = JSON.parse(acReturn);\n    if (acReturn.status != 'success')\n        return \"\";\n\n    return acReturn.resource;\n}","inputVariables":["acReturn"],"outputVariable":"whatsappAccount","LocalTimeZoneEnabled":false},"conditions":[]},{"$id":"77e1d40e-3991-4dc0-9d2b-79bac670c830","type":"ProcessHttp","$title":"Get contact from router","$invalid":false,"settings":{"headers":{"Authorization":"{{config.routerKey}}","Content-Type":"application/json"},"method":"POST","body":"{  \n  \"id\": \"{{random.guid}}\",\n  \"method\": \"get\",\n  \"uri\": \"/contacts/{{completePhoneNumber}}%40wa.gw.msging.net\"\n}","uri":"{{config.commands}}","responseStatusVariable":"contStatus","responseBodyVariable":"contReturn"},"conditions":[]},{"$id":"d61feba1-bc31-461e-af38-08debbe32c71","type":"ExecuteScript","$title":"Retorna resource","$invalid":false,"settings":{"function":"run","source":"/**\n            * All input variables needs to be passed as function param;\n            * Objects received as param needs to be parsed. Ex.: JSON.parse(inputVariable1);\n            * Objects returned needs to be stringfied. Ex.: JSON.stringify(inputVariable1);\n            **/\nfunction run(contStatus, contReturn) {\n    contReturn = JSON.parse(contReturn);\n    if (contStatus != 200 || contReturn.status != 'success' || (contReturn.reason && contReturn.reason.code == 67))\n        return 'error';\n\n    return contReturn.resource;\n}","inputVariables":["contStatus","contReturn"],"outputVariable":"resourceContact","LocalTimeZoneEnabled":false},"conditions":[]},{"$id":"dc0ee197-6aa6-428f-a944-5bb16a254e02","$typeOfContent":"","type":"ExecuteScript","$title":"Update NAME","$invalid":false,"settings":{"function":"run","source":"\nfunction run(resourceContact, whatsappAccount, tunnelId) {\n    resourceContact = JSON.parse(resourceContact);\n    resourceContact.identity = tunnelId;\n\n    if (whatsappAccount !== \"\") {\n        whatsappAccount = JSON.parse(whatsappAccount);\n        resourceContact.name = whatsappAccount.fullName;\n    }\n    else {\n        if (resourceContact.name === \"\" || resourceContact.name === \"team\") {\n            resourceContact.name = resourceContact.phoneNumber;\n        }\n    }\n\n    return resourceContact;\n}","inputVariables":["resourceContact","whatsappAccount","tunnel.identity"],"outputVariable":"resourceContact","LocalTimeZoneEnabled":false},"conditions":[]},{"$id":"048d8fd4-ab63-4bba-a75b-59587fc60356","$typeOfContent":"","type":"ExecuteScript","$title":"GET NAME","$invalid":false,"settings":{"function":"run","source":"/**\n* All input variables needs to be passed as function param;\n* Objects received as param needs to be parsed. Ex.: JSON.parse(inputVariable1);\n* Objects returned needs to be stringfied. Ex.: JSON.stringify(inputVariable1);\n**/\nfunction run(resourceContact) {\n    resourceContact = JSON.parse(resourceContact);\n\n    return resourceContact.name;\n}","inputVariables":["resourceContact"],"outputVariable":"whatsAppName","LocalTimeZoneEnabled":false},"conditions":[]},{"$id":"de037055-b7d4-4ea3-8831-ffc2cc31e192","type":"ProcessHttp","$title":"Update contact","$invalid":false,"settings":{"headers":{"Authorization":"{{config.apiKey}}","Content-Type":"application/json"},"method":"POST","body":"\n{\n\t\"id\": \"{{random.guid}}\",\n\t\"method\": \"set\",\n\t\"uri\": \"/contacts\",\n\t\"type\": \"application/vnd.lime.contact+json\",\n\t\"resource\": {{resourceContact}}\n}\n","uri":"{{config.commands}}","responseStatusVariable":"upStatus","responseBodyVariable":"upReturn"},"conditions":[{"source":"context","comparison":"notEquals","variable":"resourceContact","values":["error"]}]},{"$id":"bcf223ad-a341-4977-b5a7-6680bbc56ce8","$typeOfContent":"","type":"MergeContact","$title":"Atualiza Nome Contato","$invalid":false,"settings":{"extras":{},"name":"{{whatsAppName}}"},"conditions":[]},{"$id":"06fb9871-968c-4345-8776-d065665e55fe","$typeOfContent":"","type":"ProcessHttp","$title":"Process \"responseTicketMonitor\" using \"POST\" \"Subscribe\"","$invalid":false,"settings":{"headers":{"X-Blip-User":"{{tunnel.identity}}","X-Blip-Bot":"{{config.botIdentity}}","X-Desk-Team":"Default"},"method":"POST","body":"{\n    \"firstName\": \"John\",\n    \"lastName\": \"Doe\"\n}","uri":"{{config.ApiUrl}}/v1/Subscription/Subscribe","responseStatusVariable":"statusTicketMonitor","responseBodyVariable":"responseTicketMonitor"},"conditions":[]},{"$id":"b53534d8-8ad0-4045-94a1-244f41b500bd","$typeOfContent":"","type":"SetVariable","$title":"recordBroadcast","$invalid":false,"settings":{"variable":"recordBroadcast","value":"true"},"conditions":[{"source":"context","comparison":"exists","values":[],"variable":"contact.extras.broadcastOrigem"}]},{"$id":"42400b6a-dea6-4245-8275-ea9bc0cdf5ad","$typeOfContent":"","type":"SetVariable","$title":"respostaTemplate","$invalid":false,"settings":{"variable":"respostaTemplate","value":"{{input.content}}"},"conditions":[{"source":"context","comparison":"exists","values":[],"variable":"contact.extras.broadcastOrigem"}]}],"$inputSuggestions":[],"$defaultOutput":{"stateId":"fallback","$invalid":false},"id":"onboarding","root":true,"$position":{"top":"257px","left":"344px"},"$title":"Início","$invalidContentActions":false,"$invalidOutputs":false,"$invalidCustomActions":false,"$invalid":false,"$tags":[{"background":"#1FE5BD","label":"LastStateUpdateScript","canChangeBackground":false,"id":"blip-tag-62d0f16e-9923-4f7d-b397-fb22de20d57c"},{"background":"#CCA2E1","label":"InputScripts","id":"blip-tag-8cc68c9d-bdf1-45ef-95b7-7824d8eef532","canChangeBackground":false},{"id":"blip-tag-8ee0f384-bd95-4b1b-8ead-14d41fd813e0","label":"ExecuteScript","background":"#FF961E","canChangeBackground":false},{"id":"blip-tag-af83c04e-e89c-4178-993f-b9cc618e8d1b","label":"ProcessHttp","background":"#7762E3","canChangeBackground":false},{"id":"blip-tag-1b9e44aa-ebe2-4e7e-9a3c-eef220c7ad07","label":"MergeContact","background":"#FF1E90","canChangeBackground":false},{"id":"blip-tag-ebb31570-2b76-4fa4-b5c3-0ae7a789dbae","label":"SetVariable","background":"#FF4A1E","canChangeBackground":false},{"id":"blip-tag-10cc71b6-e6cd-4c9f-88d5-f7529e1ba1e2","label":"UserInput","background":"#000000","canChangeBackground":false}]},"fallback":{"$contentActions":[{"input":{"bypass":true,"$cardContent":{"document":{"id":"95b10ba8-e351-4d16-9b10-ce14961cb1fd","type":"text/plain","content":"Entrada do usuário"},"editable":false,"deletable":true,"position":"right"},"$invalid":false},"$invalid":false}],"$conditionOutputs":[{"stateId":"error","conditions":[{"source":"input","comparison":"matches","values":[".*"]}],"$connId":"con_8","$invalid":false,"$id":"68badaf3-d1f5-4fc9-9497-908519ceac88"}],"$enteringCustomActions":[],"$leavingCustomActions":[],"$inputSuggestions":[],"$defaultOutput":{"stateId":"onboarding","$invalid":false},"id":"fallback","$position":{"top":"216px","left":"1611px"},"$title":"Exceções","$invalidContentActions":false,"$invalidOutputs":false,"$invalidCustomActions":false,"$invalid":false},"error":{"$contentActions":[{"action":{"type":"SendMessage","settings":{"id":"00000000-0000-0000-0000-000000000002","type":"application/vnd.lime.chatstate+json","content":{"state":"composing","interval":1000}},"$cardContent":{"document":{"id":"00000000-0000-0000-0000-000000000002","type":"application/vnd.lime.chatstate+json","content":{"state":"composing","interval":1000}},"editable":true,"deletable":true,"position":"left"}},"$invalid":false},{"action":{"type":"SendMessage","settings":{"id":"00000000-0000-0000-0000-000000000003","type":"text/plain","content":"Desculpe, não consegui entender!"},"$cardContent":{"document":{"id":"00000000-0000-0000-0000-000000000003","type":"text/plain","content":"Desculpe, não consegui entender!"},"editable":true,"deletable":true,"position":"left"}},"$invalid":false},{"input":{"bypass":false,"$cardContent":{"document":{"id":"a1f34699-dd5c-43b6-8345-fde58dc32c0d","type":"text/plain","content":"Entrada do usuário"},"editable":false,"deletable":true,"position":"right"},"$invalid":false},"$invalid":false}],"$conditionOutputs":[],"$enteringCustomActions":[{"type":"TrackEvent","$title":"Registro de eventos - Last State","$invalid":false,"settings":{"extras":{"userId":"{{contact.identity}}","originatorMessageId":"{{input.message@id}}","userEmail":"{{contact.email}}","userName":"{{contact.name}}","sessionId":"{{sessionId}}"},"category":"Erro padrão - origem","action":"{{lastState}}"},"conditions":[]},{"type":"TrackEvent","$title":"Registro de eventos - Exibicao","$invalid":false,"settings":{"extras":{"userId":"{{contact.identity}}","originatorMessageId":"{{input.message@id}}","userEmail":"{{contact.email}}","userName":"{{contact.name}}","sessionId":"{{sessionId}}"},"category":"Erro padrão","action":"Exibicao"}}],"$leavingCustomActions":[],"$inputSuggestions":[],"$defaultOutput":{"stateId":"onboarding","$invalid":false},"id":"error","$position":{"top":"62px","left":"1611px"},"$title":"[E.0] Erro padrão","$invalidContentActions":false,"$invalidOutputs":false,"$invalidCustomActions":false,"$invalid":false,"$tags":[{"background":"#CCA2E1","label":"InputScripts","canChangeBackground":false,"id":"blip-tag-8cc68c9d-bdf1-45ef-95b7-7824d8eef532"},{"id":"blip-tag-9db94592-b7a3-4339-b2b9-29b79e831935","label":"TrackEvent","background":"#61D36F","canChangeBackground":false},{"id":"blip-tag-49742ed3-f4e7-4b6a-be14-7413ad73d852","label":"SendMessage","background":"#EE82EE","canChangeBackground":false},{"id":"blip-tag-5675f8cc-8b05-41a8-91e5-d1a47ba363bf","label":"UserInput","background":"#000000","canChangeBackground":false}]},"d31bede6-edf2-4e4a-8016-069520586558":{"$contentActions":[{"input":{"bypass":true,"$cardContent":{"document":{"id":"1a44e02d-59ff-48b6-8894-1d1ac19492ee","type":"text/plain","textContent":"Entrada do usuário","content":"Entrada do usuário"},"editable":false,"deletable":true,"position":"right","editing":false},"$invalid":false},"$invalid":false,"$$hashKey":"object:490"}],"$conditionOutputs":[{"stateId":"142e4c25-38ca-45e7-87ac-454feaf710a4","typeOfStateId":"state","$connId":"con_13","$id":"e2bbc203-1098-4e3e-8f05-f54b8c7d176e","conditions":[{"source":"input","comparison":"exists","values":[],"$$hashKey":"object:503"}],"$invalid":false,"$$hashKey":"object:492"}],"$enteringCustomActions":[{"$id":"0ea602e7-dc00-4275-8f64-ac4dfc5bbcaf","type":"SetVariable","$title":"ticketResponse","$invalid":false,"settings":{"variable":"ticketResponse","value":"{{input.content}}"},"conditions":[]},{"$id":"f15ae6b2-ddee-41c0-9ad0-fb1429afcca4","$typeOfContent":"","type":"ProcessHttp","$title":"Process \"responseTicketMonitor\" using \"POST\" \"Unsubscribe\"","$invalid":false,"settings":{"headers":{"X-Blip-User":"{{tunnel.identity}}","X-Blip-Bot":"{{config.botIdentity}}"},"method":"POST","body":"{\n    \"firstName\": \"John\",\n    \"lastName\": \"Doe\"\n}","uri":"{{config.ApiUrl}}/v1/Subscription/Unsubscribe","responseStatusVariable":"statusTicketMonitor","responseBodyVariable":"responseTicketMonitor"},"conditions":[]},{"$id":"3bd9df18-6fd4-4f6b-8079-de6a96ed89be","$typeOfContent":"","type":"SetVariable","$title":"sequencialId","$invalid":false,"settings":{"variable":"sequencialId","value":"{{input.content@sequentialId}}"},"conditions":[]},{"$id":"cca4026a-bf2e-4ebf-b180-1e5002b8cce9","$typeOfContent":"","type":"SetVariable","$title":"responseTags","$invalid":false,"settings":{"variable":"responseTags","value":"{{input.content@tags}}"},"conditions":[]},{"$id":"8f88531f-7a6d-4425-bf50-f327c357726e","$typeOfContent":"","type":"SetVariable","$title":"responseTeam","$invalid":false,"settings":{"variable":"responseTeam","value":"{{input.content@team}}"},"conditions":[]},{"$id":"5ef6b5eb-de56-46d0-beef-53b0452949cf","$typeOfContent":"","type":"ExecuteScript","$title":"CONVERTE DATA E HORA","$invalid":false,"settings":{"function":"run","source":"function run() {\n\n    var hoje = new Date();\n\n    let day = hoje.getDate() < 10 ? '0' + hoje.getDate() : hoje.getDate();\n    let month = hoje.getMonth() + 1;\n    const newDate = `${day}/${month < 10 ? '0' + month : month}/${hoje.getFullYear()} - ${hoje.getHours() < 10 ? '0' + hoje.getHours() : hoje.getHours()}:${hoje.getMinutes()}:${hoje.getSeconds() < 10 ? '0' + hoje.getSeconds() : hoje.getSeconds()}`\n    return newDate;\n}","inputVariables":[],"outputVariable":"dataHoraBR","LocalTimeZoneEnabled":false},"conditions":[]},{"$id":"3c6b7cf3-f09b-4875-a60b-d3f4df911692","$typeOfContent":"","type":"TrackEvent","$title":"Ticket Notificacao Ativa Novo","$invalid":false,"settings":{"extras":{},"category":"Ticket Notificacao Ativa Novo","action":"#{{sequencialId}} - {{dataHoraBr}} - {{contact.identity}} - {{contact.extras.broadcastOrigem}} - {{respostaTemplate}} - {{contact.extras.ec}} - {{agentIdentity}}"},"conditions":[{"source":"context","comparison":"equals","variable":"recordBroadcast","values":["true"],"$$hashKey":"object:1342"},{"values":["-"],"source":"context","comparison":"notEquals","variable":"contact.extras.broadcastOrigem","$$hashKey":"object:1343"}]},{"$id":"85445e44-be56-4621-b27d-690fbee2221f","$typeOfContent":"","type":"SetVariable","$title":"agentidentity","$invalid":false,"settings":{"variable":"agentIdentity","value":"{{input.content@agentIdentity}}"},"conditions":[]},{"$id":"0476c056-efd0-43fe-81f2-e7e83dc35cba","$typeOfContent":"","type":"ExecuteScript","$title":"email operador","$invalid":false,"settings":{"function":"run","source":"function run(agentIdentity) {\n  if (agentIdentity) {\n    return decodeURIComponent(agentIdentity).split('@blip.ai')[0];\n  }\n\n  return '-';\n}","inputVariables":["agentIdentity"],"outputVariable":"emailOperador","LocalTimeZoneEnabled":false},"conditions":[]},{"$id":"2c1c0559-d816-493b-a4b6-15f23c880682","$typeOfContent":"","type":"TrackEvent","$title":"notificação ativa","$invalid":false,"settings":{"extras":{},"category":"notificação ativa v2","action":"#{{sequencialId}} | {{dataHoraBr}} | {{contact.identity}} | {{contact.extras.broadcastOrigem}} | {{respostaTemplate}} | {{contact.extras.ec}} | {{responseTeam}} | {{emailOperador}} | {{responseTags}}"},"conditions":[{"values":["true"],"source":"context","comparison":"equals","variable":"recordBroadcast","$$hashKey":"object:1426"},{"values":["-"],"source":"context","comparison":"notEquals","variable":"contact.extras.broadcastOrigem","$$hashKey":"object:1427"}]},{"$id":"5a5c25ef-c9ea-4f9c-b50f-70d1fb8c3a9c","$typeOfContent":"","type":"TrackEvent","$title":"tags","$invalid":false,"settings":{"extras":{},"category":"tags","action":"{{responseTags}}"},"conditions":[]},{"$id":"826286d8-cf06-4503-93a2-d9eeed20498b","$typeOfContent":"","type":"TrackEvent","$title":"broadcast","$invalid":false,"settings":{"extras":{},"category":"broad","action":"{{contact.extras.broadcastOrigem}}"},"conditions":[{"values":[],"source":"context","comparison":"exists","variable":"contact.extras.broadcastOrigem","$$hashKey":"object:1508"},{"$$hashKey":"object:1520","values":["-"],"source":"context","variable":"contact.extras.broadcastOrigem","comparison":"notEquals"}]}],"$leavingCustomActions":[{"$id":"03f46f13-4236-403f-a08f-4419616ab647","$typeOfContent":"","type":"MergeContact","$title":"Definir contato","$invalid":false,"settings":{"extras":{"broadcastOrigem":"-"}},"conditions":[]},{"$id":"fc919374-5ec1-4d2c-b7bf-f33ed2d4e194","$typeOfContent":"","type":"SetVariable","$title":"seta false recordBroadcast","$invalid":false,"settings":{"variable":"recordBroadcast","value":"false"},"conditions":[]},{"$id":"3387118c-80ed-4838-bafe-8a2b10bff7c2","type":"ExecuteScript","$title":"DEFINE BotOrigem","$invalid":false,"settings":{"function":"run","source":"\nfunction run() {\n    var botOrigem = {\n        segmento: \"emp1\"\n    };\n\n    return botOrigem;\n}","inputVariables":[],"outputVariable":"botOrigem","LocalTimeZoneEnabled":false},"conditions":[]}],"$inputSuggestions":[],"$defaultOutput":{"stateId":"142e4c25-38ca-45e7-87ac-454feaf710a4","$invalid":false,"typeOfStateId":"state"},"$tags":[{"id":"blip-tag-48c71ac8-458e-425c-a3b3-16b7f6d4d922","label":"SetVariable","background":"#FF4A1E","canChangeBackground":false},{"id":"blip-tag-a45cfcc2-d23c-4ad0-942f-ade0cc207f0c","label":"ProcessHttp","background":"#7762E3","canChangeBackground":false},{"id":"blip-tag-316a391d-f2b1-4d12-bc98-01b179eb2e7d","label":"ExecuteScript","background":"#FF961E","canChangeBackground":false},{"id":"blip-tag-37159978-28bf-4bcb-b608-22bfc3edcb52","label":"TrackEvent","background":"#61D36F","canChangeBackground":false},{"id":"blip-tag-c8c621dc-f220-41e3-a598-1c3c3687b6aa","label":"MergeContact","background":"#FF1E90","canChangeBackground":false}],"id":"d31bede6-edf2-4e4a-8016-069520586558","root":false,"$title":"Navegar NPS","$position":{"top":"272px","left":"1036px"},"$invalidContentActions":false,"$invalidOutputs":false,"$invalidCustomActions":false,"$invalid":false},"desk:b9c4c16e-12aa-4c01-a6f3-ccda7e3fe57e":{"$contentActions":[{"input":{"bypass":false,"conditions":[{"source":"context","variable":"helpDeskHasTicket","comparison":"equals","values":["true"]}],"$cardContent":{"document":{"id":"0c0a8c4c-ea79-41bb-85a3-772edc4197d3","type":"text/plain","textContent":"User input","content":"User input"},"editable":false,"deletable":true,"position":"right","editing":false},"$invalid":false},"$invalid":false,"$$hashKey":"object:888"}],"$conditionOutputs":[{"$isDeskOutput":true,"conditions":[{"source":"context","variable":"input.type","comparison":"equals","values":["application/vnd.iris.ticket+json"]},{"source":"context","variable":"input.content@status","comparison":"equals","values":["ClosedAttendant"]}],"$id":"899b7122-ffe3-4e51-a86d-fe7e583fad07","$invalid":false,"stateId":"fa12cdcd-f726-4e1a-8817-4111b4cf5bb7","$connId":"con_58","$$hashKey":"object:891"},{"$isDeskOutput":true,"conditions":[{"source":"context","variable":"input.type","comparison":"equals","values":["application/vnd.iris.ticket+json"]},{"source":"context","variable":"input.content@status","comparison":"equals","values":["ClosedClient"]}],"$id":"e9f8d22b-119b-4bb5-8a2c-ffef1a53ae60","$invalid":false,"stateId":"fa12cdcd-f726-4e1a-8817-4111b4cf5bb7","$connId":"con_93","$$hashKey":"object:892"},{"$isDeskOutput":true,"conditions":[{"source":"context","variable":"input.type","comparison":"equals","values":["application/vnd.iris.ticket+json"]},{"source":"context","variable":"input.content@status","comparison":"equals","values":["ClosedClientInactivity"]}],"$invalid":false,"stateId":"fa12cdcd-f726-4e1a-8817-4111b4cf5bb7","$connId":"con_98","$id":"61e65636-907f-4693-9417-6e49b0e93624","$$hashKey":"object:893"}],"$enteringCustomActions":[{"$id":"bff56a0a-0317-44e9-a204-82729229cca1","$typeOfContent":"","type":"ExecuteScript","$invalid":false,"conditions":[{"source":"context","variable":"state.previous.id","comparison":"notEquals","values":["desk:a70159e8-c4b7-4ea7-ae20-da6c55d17bce"]},{"source":"context","variable":"tunnel.identity","comparison":"exists","values":[]}],"settings":{"function":"run","source":"function run(contact, tunnel_identity) {\n    contact = JSON.parse(contact);\n    contact.identity = tunnel_identity;\n    return contact;\n}","inputVariables":["contact.serialized","tunnel.identity"],"outputVariable":"deskUpdateTunnelContactBody","LocalTimeZoneEnabled":false}},{"$id":"21b4cc39-16ef-44f0-8b2f-b70ad172bf80","$typeOfContent":"","type":"ProcessCommand","$invalid":false,"conditions":[{"source":"context","variable":"state.previous.id","comparison":"notEquals","values":["desk:a70159e8-c4b7-4ea7-ae20-da6c55d17bce"]},{"source":"context","variable":"tunnel.identity","comparison":"exists","values":[]}],"settings":{"to":"postmaster@msging.net","from":"{{application.identity}}","method":"merge","uri":"/contacts","type":"application/vnd.lime.contact+json","resource":"{{deskUpdateTunnelContactBody}}","variable":"mergeRouterContactWithTunnelCommandResponse"}},{"$id":"db84217e-1fde-4c32-a93f-aca257edaf27","$typeOfContent":"","type":"ExecuteScript","$title":"GetEncodedContactIdentity","$invalid":false,"conditions":[{"source":"context","variable":"state.previous.id","comparison":"notEquals","values":["desk:a70159e8-c4b7-4ea7-ae20-da6c55d17bce"]}],"settings":{"function":"run","source":"function run(identity) {\n return (identity !== undefined) ? encodeURIComponent(identity) : identity;\n}","inputVariables":["input.message.fromidentity"],"outputVariable":"helpDeskEncodedFromIdentity","LocalTimeZoneEnabled":false}},{"$id":"b3dbefc3-eec4-406e-a417-7320f27e75cc","$typeOfContent":"","type":"ProcessCommand","$title":"GetOpenTicket","$invalid":false,"conditions":[{"source":"context","variable":"state.previous.id","comparison":"notEquals","values":["desk:a70159e8-c4b7-4ea7-ae20-da6c55d17bce"]}],"settings":{"from":"{{application.identifier}}@{{application.domain}}","to":"postmaster@desk.msging.net","method":"get","uri":"/tickets?$filter=customerIdentity%20eq%20%27{{helpDeskEncodedFromIdentity}}%27%20and%20%28status%20eq%20%27Open%27%20or%20status%20eq%20%27Waiting%27%20or%20status%20eq%20%27Assigned%27%29","metadata":{"server.shouldStore":true},"variable":"helpDeskGetOpenTicketCommandResponse"}},{"$id":"31fdf3e8-c200-49c5-a8e1-032ea07ef6cd","$typeOfContent":"","type":"ExecuteScript","$title":"TreatGetOpenTicketResponse","$invalid":false,"conditions":[{"source":"context","variable":"state.previous.id","comparison":"notEquals","values":["desk:a70159e8-c4b7-4ea7-ae20-da6c55d17bce"]}],"settings":{"function":"run","source":"function run(commandResponse) {\n    var response = JSON.parse(commandResponse)\n    var ticketExists = (response && response.resource && response.resource.items && response.resource.items.length > 0);\n  return ticketExists ? \"true\" : \"false\";\n}","inputVariables":["helpDeskGetOpenTicketCommandResponse"],"outputVariable":"helpDeskHasTicket","LocalTimeZoneEnabled":false}},{"$id":"02101825-f250-431c-9823-3f4881efc8f2","$typeOfContent":"","type":"ProcessCommand","$title":"OpenTicketIfNotFound","$invalid":false,"conditions":[{"source":"context","variable":"helpDeskHasTicket","comparison":"notEquals","values":["true"]}],"settings":{"from":"{{application.identifier}}@{{application.domain}}","to":"postmaster@desk.msging.net","method":"set","uri":"/tickets/{{helpDeskEncodedFromIdentity}}","variable":"helpDeskOpenTicketCommandResponse","type":"text/plain","resource":"{{input.content}}","metadata":{"server.shouldStore":true}}},{"$id":"68220ec3-432b-4741-8e53-1d3abb47914f","$typeOfContent":"","type":"ExecuteScript","$title":"TreatOpenTicketResponse","$invalid":false,"conditions":[{"source":"context","variable":"helpDeskHasTicket","comparison":"notEquals","values":["true"]}],"settings":{"function":"run","source":"function run(commandResponse) {\n    var response = commandResponse ? JSON.parse(commandResponse) : {}\n    var ticketExists = response && response.type === \"application/vnd.iris.ticket+json\" && response.resource \n    return ticketExists ? \"true\" : \"false\";\n}","inputVariables":["helpDeskOpenTicketCommandResponse"],"outputVariable":"helpDeskHasTicket","LocalTimeZoneEnabled":false}},{"$id":"7f7cd263-e380-4bb2-a5b5-f33d622e00bd","$typeOfContent":"","type":"ForwardMessageToDesk","conditions":[{"source":"context","variable":"helpDeskHasTicket","comparison":"equals","values":["true"]}],"settings":{},"$invalid":false}],"$leavingCustomActions":[{"$id":"722a8034-0e7a-4b0b-a1d9-c9bd6c77ff9f","type":"SetVariable","$title":"ResetHasTicket","$invalid":false,"conditions":[{"source":"context","variable":"input.type","comparison":"equals","values":["application/vnd.iris.ticket+json"]},{"source":"context","variable":"input.content@status","comparison":"equals","values":["ClosedAttendant","ClosedClient"]}],"settings":{"variable":"helpDeskHasTicket","value":"false","$invalid":false}}],"$inputSuggestions":[],"$defaultOutput":{"stateId":"desk:b9c4c16e-12aa-4c01-a6f3-ccda7e3fe57e","$invalid":false},"$tags":[{"id":"blip-tag-559c5976-7588-4a7f-a982-8bd059bf98d2","label":"ExecuteScript","background":"#FF961E","canChangeBackground":false},{"id":"blip-tag-a9686cd7-3cfc-410e-b8c2-a86f7af3c301","label":"ProcessCommand","background":"#FC91AE","canChangeBackground":false},{"id":"blip-tag-28ea53fa-e69d-4b52-b9da-a7853399d7ef","label":"ForwardMessageToDesk","background":"#8AAC44","canChangeBackground":false},{"id":"blip-tag-76fa2f83-498e-495c-a112-e21f8f914eba","label":"SetVariable","background":"#FF4A1E","canChangeBackground":false},{"id":"blip-tag-fce03330-70c8-4511-b128-1b9b35dfbbc8","label":"UserInput","background":"#000000","canChangeBackground":false}],"id":"desk:b9c4c16e-12aa-4c01-a6f3-ccda7e3fe57e","deskStateVersion":"2.00","root":false,"$title":"[6] Atendimento humano","$position":{"top":"255.571px","left":"602px"},"$invalidContentActions":false,"$invalidOutputs":false,"$invalidCustomActions":false,"$invalid":false},"142e4c25-38ca-45e7-87ac-454feaf710a4":{"$contentActions":[{"input":{"bypass":true,"$cardContent":{"document":{"id":"093e74ab-121d-4d2f-8d25-e81e1afc5844","type":"text/plain","textContent":"Entrada do usuário","content":"Entrada do usuário"},"editable":false,"deletable":true,"position":"right","editing":false},"$invalid":false},"$invalid":false,"$$hashKey":"object:359"}],"$conditionOutputs":[],"$enteringCustomActions":[{"$id":"11b2b165-3e95-4a7a-b8f6-572ecffec86f","$typeOfContent":"","type":"Redirect","$title":"Redirecionar a um serviço","$invalid":false,"settings":{"context":{"type":"text/plain","value":"{{botOrigem}}"},"address":"nps"},"conditions":[]}],"$leavingCustomActions":[],"$inputSuggestions":[],"$defaultOutput":{"stateId":"onboarding","$invalid":false,"typeOfStateId":"state"},"$tags":[{"id":"blip-tag-ccc7d72c-4293-49d5-aff0-635e4aa7bffe","label":"Redirect","background":"#1EA1FF","canChangeBackground":false}],"id":"142e4c25-38ca-45e7-87ac-454feaf710a4","root":false,"$title":"Novo bloco","$position":{"top":"270px","left":"1263px"},"$invalidContentActions":false,"$invalidOutputs":false,"$invalidCustomActions":false,"$invalid":false},"fa12cdcd-f726-4e1a-8817-4111b4cf5bb7":{"$contentActions":[{"input":{"bypass":true,"$cardContent":{"document":{"id":"db6857dc-4c1e-4881-bc4d-630e4c2c0193","type":"text/plain","textContent":"Entrada do usuário","content":"Entrada do usuário"},"editable":false,"deletable":true,"position":"right","editing":false},"$invalid":false},"$invalid":false,"$$hashKey":"object:942"}],"$conditionOutputs":[{"stateId":"d31bede6-edf2-4e4a-8016-069520586558","typeOfStateId":"state","$connId":"con_43","$id":"4eedf6c2-d74a-45f7-8342-d7276c7c5027","conditions":[{"source":"input","comparison":"exists","values":[],"$$hashKey":"object:955"}],"$invalid":false,"$$hashKey":"object:944"}],"$enteringCustomActions":[{"$id":"9102a392-44bb-4dd1-b6bd-729783b40e68","type":"SetVariable","$title":"Set retornoTicket","$invalid":false,"settings":{"variable":"retornoTicket","value":"{{input.content}}"},"conditions":[]},{"$id":"efd94234-023a-438e-8baf-95ee1a6303b3","$typeOfContent":"","type":"ExecuteScript","$title":"Process \"dataHoraBR\"","$invalid":false,"settings":{"function":"run","source":"function run() {\n\n    var hoje = new Date();\n\n    let day = hoje.getDate() < 10 ? '0' + hoje.getDate() : hoje.getDate();\n    let month = hoje.getMonth() + 1;\n    const newDate = `${day}/${month < 10 ? '0' + month : month}/${hoje.getFullYear()} - ${hoje.getHours() < 10 ? '0' + hoje.getHours() : hoje.getHours()}:${hoje.getMinutes()}:${hoje.getSeconds() < 10 ? '0' + hoje.getSeconds() : hoje.getSeconds()}`\n    return newDate;\n}","inputVariables":[],"outputVariable":"dataHoraBR","LocalTimeZoneEnabled":false},"conditions":[]},{"$id":"ccfc9c0a-fd8b-4a16-9557-a5cd8a34503e","type":"ExecuteScript","$title":"retorna dataHoraAberturaTicket","$invalid":false,"settings":{"function":"run","source":"function run(ticket) {\n    let _ticket = JSON.parse(ticket);\n\n    if(_ticket.openDate){\n        let date = new Date(_ticket.openDate);\n        let day = date.getUTCDate() < 10 ? \"0\" + date.getUTCDate() : date.getUTCDate();\n        let month = (date.getUTCMonth()+1) < 10 ? \"0\" + (date.getUTCMonth()+1) : (date.getUTCMonth()+1);\n        let hour = (date.getUTCHours()-3) < 10 ? \"0\" + (date.getUTCHours()-3) : (date.getUTCHours()-3);\n        let minutes = date.getUTCMinutes() < 10 ? \"0\" + date.getUTCMinutes() : date.getUTCMinutes();\n        let seconds =  date.getUTCSeconds() < 10 ? \"0\" +  date.getUTCSeconds() :  date.getUTCSeconds();\n        let newDate = day + \"/\" + month + \"/\" + date.getUTCFullYear() + \" \" + hour + \":\" + minutes + \":\" + seconds;\n        return newDate;\n    }\n\n    return \"NA\";\n}","inputVariables":["input.content"],"outputVariable":"dataHoraAberturaTicket","LocalTimeZoneEnabled":false},"conditions":[],"continueOnError":false},{"$id":"f215d8bd-42a3-4bf8-a4b4-6c4a1a8ddaea","$typeOfContent":"","type":"SetVariable","$title":"Set \"sequencialId\"","$invalid":false,"settings":{"variable":"sequencialId","value":"{{input.content@sequentialId}}"},"conditions":[]},{"$id":"a5fa615c-9e22-4a14-8dc4-c0f18f06a388","$typeOfContent":"","type":"SetVariable","$title":"Set \"ticketId\"","$invalid":false,"settings":{"variable":"ticketId","value":"{{input.content@id}}"},"conditions":[]},{"$id":"ab2c5343-bc2f-4647-a972-348c9a184cde","$typeOfContent":"","type":"SetVariable","$title":"Set \"responseTags\"","$invalid":false,"settings":{"variable":"responseTags","value":"{{input.content@tags}}"},"conditions":[]},{"$id":"5ab4ccb7-2cf0-4180-9e69-4ddea8e94f25","$typeOfContent":"","type":"SetVariable","$title":"Set \"responseTeam\"","$invalid":false,"settings":{"variable":"responseTeam","value":"{{input.content@team}}"},"conditions":[]},{"$id":"7d38c93a-39b1-4e81-b378-6ef99ef88aaf","$typeOfContent":"","type":"SetVariable","$title":"Set \"agentIdentity\"","$invalid":false,"settings":{"variable":"agentIdentity","value":"{{input.content@agentIdentity}}"},"conditions":[]},{"$id":"792c8e6a-8b94-47c9-9f5d-2fc8a2723957","$typeOfContent":"","type":"ExecuteScript","$title":"Process \"agentIdentity\" formatado","$invalid":false,"settings":{"function":"run","source":"function run(email) {\n\n    const mail = email.split('@')[0];\n   \n    return mail.replace(\"%40\", \"@\");\n}","inputVariables":["agentIdentity"],"outputVariable":"agentIdentity","LocalTimeZoneEnabled":false},"conditions":[{"values":[],"source":"context","comparison":"exists","variable":"agentIdentity"}]},{"$id":"3757d866-087b-4bfc-aa29-8107fa24ff7c","type":"ExecuteScript","$title":"retorna dataHoraFechamentoTicket","$invalid":false,"settings":{"function":"run","source":"function run(ticket) {\n    let _ticket = JSON.parse(ticket);\n\n    if(_ticket.closeDate){\n        let date = new Date(_ticket.closeDate);\n        let day = date.getUTCDate() < 10 ? \"0\" + date.getUTCDate() : date.getUTCDate();\n        let month = (date.getUTCMonth()+1) < 10 ? \"0\" + (date.getUTCMonth()+1) : (date.getUTCMonth()+1);\n        let hour = (date.getUTCHours()-3) < 10 ? \"0\" + (date.getUTCHours()-3) : (date.getUTCHours()-3);\n        let minutes = date.getUTCMinutes() < 10 ? \"0\" + date.getUTCMinutes() : date.getUTCMinutes();\n        let seconds =  date.getUTCSeconds() < 10 ? \"0\" +  date.getUTCSeconds() :  date.getUTCSeconds();\n        let newDate = day + \"/\" + month + \"/\" + date.getUTCFullYear() + \" \" + hour + \":\" + minutes + \":\" + seconds;\n        return newDate;\n    }\n\n    return \"NA\";\n}","inputVariables":["input.content"],"outputVariable":"dataHoraFechamentoTicket","LocalTimeZoneEnabled":false},"conditions":[],"continueOnError":false}],"$leavingCustomActions":[],"$inputSuggestions":[],"$defaultOutput":{"stateId":"d31bede6-edf2-4e4a-8016-069520586558","$invalid":false,"typeOfStateId":"state"},"$tags":[{"id":"blip-tag-45d097f1-65f8-46af-ba7b-09ac292e07fa","label":"SetVariable","background":"#FF4A1E","canChangeBackground":false},{"id":"blip-tag-53eb422b-fecb-403c-94bf-9dc80691216a","label":"ExecuteScript","background":"#FF961E","canChangeBackground":false}],"id":"fa12cdcd-f726-4e1a-8817-4111b4cf5bb7","root":false,"$title":"[Dados CSAT]","$position":{"top":"271px","left":"821px"},"$invalidContentActions":false,"$invalidOutputs":false,"$invalidCustomActions":false,"$invalid":false,"isAiGenerated":false}},"configuration":{"builder:minimumIntentScore":"0.7","builder:stateTrack":"false","builder:useTunnelOwnerContext":"true","apiKey":"Key c2FmcmFwcm9kZ2VyZGlnZW1wMTo2bEVPZVVjNUNOOW05cXBBMVlqaA==","commands":"https://safra.http.msging.net/commands","builder:#localTimeZone":"E. South America Standard Time","routerKey":"Key c2FmcmFwcm9kZGlnZW1wcm91dGVyMjpEcVJ0MjRJZFFxYVNMMmhOM1l1NQ==","TraceTarget":"https://take-api-beholder.cs.blip.ai/api/traces/safraprodgerdigemp1","TraceMode":"All","TraceTargetType":"Http","botIdentity":"safraprodgerdigemp1","ApiUrl":"https://ticketmonitor.cs.blip.ai"},"globalActions":{"$contentActions":[],"$conditionOutputs":[],"$enteringCustomActions":[],"$leavingCustomActions":[],"$inputSuggestions":[],"$defaultOutput":{"stateId":"fallback","$invalid":false},"$tags":[],"id":"global-actions","$invalidContentActions":false,"$invalidOutputs":false,"$invalidCustomActions":false,"$invalid":false}}