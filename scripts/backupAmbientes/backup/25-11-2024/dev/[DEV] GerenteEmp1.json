{"flow":{"onboarding":{"$contentActions":[{"input":{"bypass":false,"$cardContent":{"document":{"id":"a5f855b2-7344-44ad-bf8b-75bccd63d288","type":"text/plain","content":"Inicio"},"editable":false,"deletable":false,"position":"right"},"$invalid":false,"variable":"Inicio"},"$invalid":false,"$$hashKey":"object:2923"}],"$conditionOutputs":[{"stateId":"desk:b9c4c16e-12aa-4c01-a6f3-ccda7e3fe57e","$connId":"con_3","$id":"4c6b3d4e-49f8-4e8a-a55c-840600014557","conditions":[{"source":"input","comparison":"exists","values":[],"$$hashKey":"object:2969"}],"$invalid":false,"$$hashKey":"object:2950"}],"$enteringCustomActions":[],"$leavingCustomActions":[{"$id":"3cffad3f-a425-4f3d-af14-4a70650ca397","type":"ExecuteScript","$title":"Get phoneNumber","$invalid":false,"settings":{"function":"run","source":"/**\n            * All input variables needs to be passed as function param;\n            * Objects received as param needs to be parsed. Ex.: JSON.parse(inputVariable1);\n            * Objects returned needs to be stringfied. Ex.: JSON.stringify(inputVariable1);\n            **/\n            function run(originator) {\n                return originator.split('@')[0];\n            }","inputVariables":["tunnel.originator"],"outputVariable":"completePhoneNumber"},"conditions":[]},{"$id":"480b9d42-dd04-46a9-ba54-6e49d130bbf5","type":"ProcessHttp","$title":"Get alternativeAccount","$invalid":false,"settings":{"headers":{"Authorization":"{{config.routerKey}}","Content-Type":"application/json"},"method":"POST","body":"{  \n  \"id\": \"{{random.guid}}\",\n  \"to\": \"postmaster@wa.gw.msging.net\",\n  \"method\": \"get\",\n  \"uri\": \"lime://wa.gw.msging.net/accounts/+{{completePhoneNumber}}\"\n}","uri":"{{config.commands}}","responseStatusVariable":"acStatus","responseBodyVariable":"acReturn"},"conditions":[]},{"$id":"a434f59b-2e93-4774-9ac0-fef629fa5228","type":"ExecuteScript","$title":"GET WhatsApp Account","$invalid":false,"settings":{"function":"run","source":"\nfunction run(acReturn) {\n    acReturn = JSON.parse(acReturn);\n    if (acReturn.status != 'success')\n        return \"\";\n\n    return acReturn.resource;\n}","inputVariables":["acReturn"],"outputVariable":"whatsappAccount"},"conditions":[]},{"$id":"77e1d40e-3991-4dc0-9d2b-79bac670c830","type":"ProcessHttp","$title":"Get contact from router","$invalid":false,"settings":{"headers":{"Authorization":"{{config.routerKey}}","Content-Type":"application/json"},"method":"POST","body":"{  \n  \"id\": \"{{random.guid}}\",\n  \"method\": \"get\",\n  \"uri\": \"/contacts/{{completePhoneNumber}}%40wa.gw.msging.net\"\n}","uri":"{{config.commands}}","responseStatusVariable":"contStatus","responseBodyVariable":"contReturn"},"conditions":[]},{"$id":"d61feba1-bc31-461e-af38-08debbe32c71","type":"ExecuteScript","$title":"Retorna resource","$invalid":false,"settings":{"function":"run","source":"/**\n            * All input variables needs to be passed as function param;\n            * Objects received as param needs to be parsed. Ex.: JSON.parse(inputVariable1);\n            * Objects returned needs to be stringfied. Ex.: JSON.stringify(inputVariable1);\n            **/\nfunction run(contStatus, contReturn) {\n    contReturn = JSON.parse(contReturn);\n    if (contStatus != 200 || contReturn.status != 'success' || (contReturn.reason && contReturn.reason.code == 67))\n        return 'error';\n\n    return contReturn.resource;\n}","inputVariables":["contStatus","contReturn"],"outputVariable":"resourceContact"},"conditions":[],"continueOnError":false},{"$id":"dc0ee197-6aa6-428f-a944-5bb16a254e02","$typeOfContent":"","type":"ExecuteScript","$title":"Update NAME","$invalid":false,"settings":{"function":"run","source":"\nfunction run(resourceContact, whatsappAccount, tunnelId) {\n    resourceContact = JSON.parse(resourceContact);\n    resourceContact.identity = tunnelId;\n\n    if (whatsappAccount !== \"\") {\n        whatsappAccount = JSON.parse(whatsappAccount);\n        resourceContact.name = whatsappAccount.fullName;\n    }\n    else {\n        if (resourceContact.name === \"\" || resourceContact.name === \"team\") {\n            resourceContact.name = resourceContact.phoneNumber;\n        }\n    }\n\n    return resourceContact;\n}","inputVariables":["resourceContact","whatsappAccount","tunnel.identity"],"outputVariable":"resourceContact"},"conditions":[],"continueOnError":false},{"$id":"048d8fd4-ab63-4bba-a75b-59587fc60356","$typeOfContent":"","type":"ExecuteScript","$title":"GET NAME","$invalid":false,"settings":{"function":"run","source":"/**\n* All input variables needs to be passed as function param;\n* Objects received as param needs to be parsed. Ex.: JSON.parse(inputVariable1);\n* Objects returned needs to be stringfied. Ex.: JSON.stringify(inputVariable1);\n**/\nfunction run(resourceContact) {\n    resourceContact = JSON.parse(resourceContact);\n\n    return resourceContact.name;\n}","inputVariables":["resourceContact"],"outputVariable":"whatsAppName"},"conditions":[],"continueOnError":false},{"$id":"de037055-b7d4-4ea3-8831-ffc2cc31e192","type":"ProcessHttp","$title":"Update contact","$invalid":false,"settings":{"headers":{"Authorization":"{{config.apiKey}}","Content-Type":"application/json"},"method":"POST","body":"\n{\n\t\"id\": \"{{random.guid}}\",\n\t\"method\": \"set\",\n\t\"uri\": \"/contacts\",\n\t\"type\": \"application/vnd.lime.contact+json\",\n\t\"resource\": {{resourceContact}}\n}\n","uri":"{{config.commands}}","responseStatusVariable":"upStatus","responseBodyVariable":"upReturn"},"conditions":[{"source":"context","comparison":"notEquals","variable":"resourceContact","values":["error"]}]},{"$id":"bcf223ad-a341-4977-b5a7-6680bbc56ce8","$typeOfContent":"","type":"MergeContact","$title":"Atualiza Nome Contato","$invalid":false,"settings":{"extras":{},"name":"{{whatsAppName}}"},"conditions":[]}],"$inputSuggestions":[],"$defaultOutput":{"stateId":"fallback","$invalid":false},"id":"onboarding","root":true,"$position":{"top":"256px","left":"343px"},"$title":"Início","$invalidContentActions":false,"$invalidOutputs":false,"$invalidCustomActions":false,"$invalid":false,"$tags":[{"background":"#1FE5BD","label":"LastStateUpdateScript","canChangeBackground":false,"id":"blip-tag-62d0f16e-9923-4f7d-b397-fb22de20d57c"},{"background":"#CCA2E1","label":"InputScripts","id":"blip-tag-8cc68c9d-bdf1-45ef-95b7-7824d8eef532","canChangeBackground":false},{"background":"#FC91AE","label":"ExecuteScript","id":"blip-tag-04cab6f5-cdaa-ee24-f72d-a4d88d595682","canChangeBackground":false}]},"fallback":{"$contentActions":[{"input":{"bypass":true,"$cardContent":{"document":{"id":"95b10ba8-e351-4d16-9b10-ce14961cb1fd","type":"text/plain","content":"Entrada do usuário"},"editable":false,"deletable":true,"position":"right"},"$invalid":false},"$invalid":false}],"$conditionOutputs":[{"stateId":"error","conditions":[{"source":"input","comparison":"matches","values":[".*"]}],"$connId":"con_8","$invalid":false,"$id":"68badaf3-d1f5-4fc9-9497-908519ceac88"}],"$enteringCustomActions":[],"$leavingCustomActions":[],"$inputSuggestions":[],"$defaultOutput":{"stateId":"onboarding","$invalid":false},"id":"fallback","$position":{"top":"216px","left":"1611px"},"$title":"Exceções","$invalidContentActions":false,"$invalidOutputs":false,"$invalidCustomActions":false,"$invalid":false},"error":{"$contentActions":[{"action":{"type":"SendMessage","settings":{"id":"00000000-0000-0000-0000-000000000002","type":"application/vnd.lime.chatstate+json","content":{"state":"composing","interval":1000}},"$cardContent":{"document":{"id":"00000000-0000-0000-0000-000000000002","type":"application/vnd.lime.chatstate+json","content":{"state":"composing","interval":1000}},"editable":true,"deletable":true,"position":"left"}},"$invalid":false},{"action":{"type":"SendMessage","settings":{"id":"00000000-0000-0000-0000-000000000003","type":"text/plain","content":"Desculpe, não consegui entender!"},"$cardContent":{"document":{"id":"00000000-0000-0000-0000-000000000003","type":"text/plain","content":"Desculpe, não consegui entender!"},"editable":true,"deletable":true,"position":"left"}},"$invalid":false},{"input":{"bypass":false,"$cardContent":{"document":{"id":"a1f34699-dd5c-43b6-8345-fde58dc32c0d","type":"text/plain","content":"Entrada do usuário"},"editable":false,"deletable":true,"position":"right"},"$invalid":false},"$invalid":false}],"$conditionOutputs":[],"$enteringCustomActions":[{"type":"TrackEvent","$title":"Registro de eventos - Last State","$invalid":false,"settings":{"extras":{"userId":"{{contact.identity}}","originatorMessageId":"{{input.message@id}}","userEmail":"{{contact.email}}","userName":"{{contact.name}}","sessionId":"{{sessionId}}"},"category":"Erro padrão - origem","action":"{{lastState}}"}},{"type":"TrackEvent","$title":"Registro de eventos - Exibicao","$invalid":false,"settings":{"extras":{"userId":"{{contact.identity}}","originatorMessageId":"{{input.message@id}}","userEmail":"{{contact.email}}","userName":"{{contact.name}}","sessionId":"{{sessionId}}"},"category":"Erro padrão","action":"Exibicao"}}],"$leavingCustomActions":[],"$inputSuggestions":[],"$defaultOutput":{"stateId":"onboarding","$invalid":false},"id":"error","$position":{"top":"62px","left":"1611px"},"$title":"[E.0] Erro padrão","$invalidContentActions":false,"$invalidOutputs":false,"$invalidCustomActions":false,"$invalid":false,"$tags":[{"background":"#CCA2E1","label":"InputScripts","canChangeBackground":false,"id":"blip-tag-8cc68c9d-bdf1-45ef-95b7-7824d8eef532"}]},"d31bede6-edf2-4e4a-8016-069520586558":{"$contentActions":[{"input":{"bypass":true,"$cardContent":{"document":{"id":"1a44e02d-59ff-48b6-8894-1d1ac19492ee","type":"text/plain","textContent":"Entrada do usuário","content":"Entrada do usuário"},"editable":false,"deletable":true,"position":"right","editing":false},"$invalid":false},"$invalid":false,"$$hashKey":"object:2524"}],"$conditionOutputs":[],"$enteringCustomActions":[{"$id":"0ea602e7-dc00-4275-8f64-ac4dfc5bbcaf","type":"SetVariable","$title":"ticketResponse","$invalid":false,"settings":{"variable":"ticketResponse","value":"{{input.content}}"},"conditions":[]}],"$leavingCustomActions":[{"$id":"3387118c-80ed-4838-bafe-8a2b10bff7c2","type":"ExecuteScript","$title":"DEFINE BotOrigem","$invalid":false,"settings":{"function":"run","source":"\nfunction run() {\n    var botOrigem = {\n        segmento: \"emp1\"\n    };\n\n    return botOrigem;\n}","inputVariables":[],"outputVariable":"botOrigem"},"conditions":[]},{"$id":"f07f88fe-6348-463b-973a-29edd845b7b8","type":"Redirect","$title":"Subbot NPS","$invalid":false,"settings":{"context":{"type":"text/plain","value":"{{botOrigem}}"},"address":"nps"},"conditions":[]}],"$inputSuggestions":[],"$defaultOutput":{"stateId":"onboarding","$invalid":false},"$tags":[{"background":"#FC91AE","label":"ExecuteScript","id":"blip-tag-04cab6f5-cdaa-ee24-f72d-a4d88d595682","canChangeBackground":false}],"id":"d31bede6-edf2-4e4a-8016-069520586558","root":false,"$title":"Navegar NPS","$position":{"top":"261px","left":"904px"},"$invalidContentActions":false,"$invalidOutputs":false,"$invalidCustomActions":false,"$invalid":false},"desk:b9c4c16e-12aa-4c01-a6f3-ccda7e3fe57e":{"$contentActions":[{"input":{"bypass":false,"conditions":[{"source":"context","variable":"helpDeskHasTicket","comparison":"equals","values":["true"]}],"$cardContent":{"document":{"id":"0c0a8c4c-ea79-41bb-85a3-772edc4197d3","type":"text/plain","textContent":"User input","content":"User input"},"editable":false,"deletable":true,"position":"right","editing":false},"$invalid":false},"$invalid":false,"$$hashKey":"object:2375"}],"$conditionOutputs":[{"$isDeskOutput":true,"conditions":[{"source":"context","variable":"input.type","comparison":"equals","values":["application/vnd.iris.ticket+json"]},{"source":"context","variable":"input.content@status","comparison":"equals","values":["ClosedAttendant"]}],"$id":"899b7122-ffe3-4e51-a86d-fe7e583fad07","$invalid":false,"stateId":"d31bede6-edf2-4e4a-8016-069520586558","$connId":"con_13","$$hashKey":"object:2400"},{"$isDeskOutput":true,"conditions":[{"source":"context","variable":"input.type","comparison":"equals","values":["application/vnd.iris.ticket+json"]},{"source":"context","variable":"input.content@status","comparison":"equals","values":["ClosedClient"]}],"$id":"e9f8d22b-119b-4bb5-8a2c-ffef1a53ae60","$invalid":false,"stateId":"d31bede6-edf2-4e4a-8016-069520586558","$connId":"con_28","$$hashKey":"object:2401"},{"$isDeskOutput":true,"conditions":[{"source":"context","variable":"input.type","comparison":"equals","values":["application/vnd.iris.ticket+json"]},{"source":"context","variable":"input.content@status","comparison":"equals","values":["ClosedClientInactivity"]}],"$invalid":false,"stateId":"d31bede6-edf2-4e4a-8016-069520586558","$connId":"con_33","$id":"61e65636-907f-4693-9417-6e49b0e93624","$$hashKey":"object:2402"}],"$enteringCustomActions":[{"$id":"bff56a0a-0317-44e9-a204-82729229cca1","$typeOfContent":"","type":"ExecuteScript","$invalid":false,"conditions":[{"source":"context","variable":"state.previous.id","comparison":"notEquals","values":["desk:a70159e8-c4b7-4ea7-ae20-da6c55d17bce"]},{"source":"context","variable":"tunnel.identity","comparison":"exists","values":[]}],"settings":{"function":"run","source":"function run(contact, tunnel_identity) {\n    contact = JSON.parse(contact);\n    contact.identity = tunnel_identity;\n    return contact;\n}","inputVariables":["contact.serialized","tunnel.identity"],"outputVariable":"deskUpdateTunnelContactBody","LocalTimeZoneEnabled":false}},{"$id":"21b4cc39-16ef-44f0-8b2f-b70ad172bf80","$typeOfContent":"","type":"ProcessCommand","$invalid":false,"conditions":[{"source":"context","variable":"state.previous.id","comparison":"notEquals","values":["desk:a70159e8-c4b7-4ea7-ae20-da6c55d17bce"]},{"source":"context","variable":"tunnel.identity","comparison":"exists","values":[]}],"settings":{"to":"postmaster@msging.net","from":"{{application.identity}}","method":"merge","uri":"/contacts","type":"application/vnd.lime.contact+json","resource":"{{deskUpdateTunnelContactBody}}","variable":"mergeRouterContactWithTunnelCommandResponse"}},{"$id":"db84217e-1fde-4c32-a93f-aca257edaf27","$typeOfContent":"","type":"ExecuteScript","$title":"GetEncodedContactIdentity","$invalid":false,"conditions":[{"source":"context","variable":"state.previous.id","comparison":"notEquals","values":["desk:a70159e8-c4b7-4ea7-ae20-da6c55d17bce"]}],"settings":{"function":"run","source":"function run(identity) {\n return (identity !== undefined) ? encodeURIComponent(identity) : identity;\n}","inputVariables":["input.message.fromidentity"],"outputVariable":"helpDeskEncodedFromIdentity","LocalTimeZoneEnabled":false}},{"$id":"b3dbefc3-eec4-406e-a417-7320f27e75cc","$typeOfContent":"","type":"ProcessCommand","$title":"GetOpenTicket","$invalid":false,"conditions":[{"source":"context","variable":"state.previous.id","comparison":"notEquals","values":["desk:a70159e8-c4b7-4ea7-ae20-da6c55d17bce"]}],"settings":{"from":"{{application.identifier}}@{{application.domain}}","to":"postmaster@desk.msging.net","method":"get","uri":"/tickets?$filter=customerIdentity%20eq%20%27{{helpDeskEncodedFromIdentity}}%27%20and%20%28status%20eq%20%27Open%27%20or%20status%20eq%20%27Waiting%27%20or%20status%20eq%20%27Assigned%27%29","metadata":{"server.shouldStore":true},"variable":"helpDeskGetOpenTicketCommandResponse"}},{"$id":"31fdf3e8-c200-49c5-a8e1-032ea07ef6cd","$typeOfContent":"","type":"ExecuteScript","$title":"TreatGetOpenTicketResponse","$invalid":false,"conditions":[{"source":"context","variable":"state.previous.id","comparison":"notEquals","values":["desk:a70159e8-c4b7-4ea7-ae20-da6c55d17bce"]}],"settings":{"function":"run","source":"function run(commandResponse) {\n    var response = JSON.parse(commandResponse)\n    var ticketExists = (response && response.resource && response.resource.items && response.resource.items.length > 0);\n  return ticketExists ? \"true\" : \"false\";\n}","inputVariables":["helpDeskGetOpenTicketCommandResponse"],"outputVariable":"helpDeskHasTicket","LocalTimeZoneEnabled":false}},{"$id":"02101825-f250-431c-9823-3f4881efc8f2","$typeOfContent":"","type":"ProcessCommand","$title":"OpenTicketIfNotFound","$invalid":false,"conditions":[{"source":"context","variable":"helpDeskHasTicket","comparison":"notEquals","values":["true"]}],"settings":{"from":"{{application.identifier}}@{{application.domain}}","to":"postmaster@desk.msging.net","method":"set","uri":"/tickets/{{helpDeskEncodedFromIdentity}}","variable":"helpDeskOpenTicketCommandResponse","type":"text/plain","resource":"{{input.content}}","metadata":{"server.shouldStore":true}}},{"$id":"68220ec3-432b-4741-8e53-1d3abb47914f","$typeOfContent":"","type":"ExecuteScript","$title":"TreatOpenTicketResponse","$invalid":false,"conditions":[{"source":"context","variable":"helpDeskHasTicket","comparison":"notEquals","values":["true"]}],"settings":{"function":"run","source":"function run(commandResponse) {\n    var response = commandResponse ? JSON.parse(commandResponse) : {}\n    var ticketExists = response && response.type === \"application/vnd.iris.ticket+json\" && response.resource \n    return ticketExists ? \"true\" : \"false\";\n}","inputVariables":["helpDeskOpenTicketCommandResponse"],"outputVariable":"helpDeskHasTicket","LocalTimeZoneEnabled":false}},{"$id":"7f7cd263-e380-4bb2-a5b5-f33d622e00bd","$typeOfContent":"","type":"ForwardMessageToDesk","conditions":[{"source":"context","variable":"helpDeskHasTicket","comparison":"equals","values":["true"]}],"settings":{},"$invalid":false}],"$leavingCustomActions":[{"$id":"722a8034-0e7a-4b0b-a1d9-c9bd6c77ff9f","type":"SetVariable","$title":"ResetHasTicket","$invalid":false,"conditions":[{"source":"context","variable":"input.type","comparison":"equals","values":["application/vnd.iris.ticket+json"]},{"source":"context","variable":"input.content@status","comparison":"equals","values":["ClosedAttendant","ClosedClient"]}],"settings":{"variable":"helpDeskHasTicket","value":"false","$invalid":false}}],"$inputSuggestions":[],"$defaultOutput":{"stateId":"desk:b9c4c16e-12aa-4c01-a6f3-ccda7e3fe57e","$invalid":false},"$tags":[],"id":"desk:b9c4c16e-12aa-4c01-a6f3-ccda7e3fe57e","deskStateVersion":"2.00","root":false,"$title":"[6] Atendimento humano","$position":{"top":"258px","left":"601px"},"$invalidContentActions":false,"$invalidOutputs":false,"$invalidCustomActions":false,"$invalid":false}},"configuration":{"builder:minimumIntentScore":"0.5","builder:stateTrack":"false","builder:#localTimeZone":"E. South America Standard Time","TraceTargetType":"Http","TraceMode":"All","TraceTarget":"https://take-api-beholder.cs.blip.ai/api/traces/devgerenteemp1","builder:useTunnelOwnerContext":"false","commands":"https://safra.http.msging.net/commands","routerKey":"Key c2FmcmFkZXZkaWdlbXByb3V0ZXIxOklFSU5DMmJpVk01WjF0Vm5ONmQ3","apiKey":"Key ZGV2Z2VyZW50ZWVtcDE6UzdzdkNnbzV2ZnQ5dHRHaWdLSEI="}}