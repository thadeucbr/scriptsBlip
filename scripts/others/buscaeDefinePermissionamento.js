var bodyPermissoes  = {
    "data": [
        {
            "codigoGrupo": "PAG",
            "codigosServicos": [
                "46",
                "47",
                "1",
                "2",
                "3",
                "4",
                "5",
                "6",
                "7",
                "8",
                "9",
                "11",
                "12",
                "13",
                "14",
                "17",
                "20",
                "22",
                "23",
                "24",
                "25",
                "27",
                "28",
                "31",
                "32",
                "33",
                "34",
                "36",
                "38",
                "39",
                "40",
                "41",
                "42",
                "43",
                "44",
                "21",
                "53",
                "37",
                "52",
                "51",
                "49",
                "50",
                "48"
            ]
        },
        {
            "codigoGrupo": "SES",
            "codigosServicos": [
                "2",
                "1"
            ]
        },
        {
            "codigoGrupo": "POS",
            "codigosServicos": [
                "47",
                "37",
                "2",
                "4",
                "5",
                "6",
                "12",
                "13",
                "31",
                "40",
                "41",
                "42",
                "43",
                "44",
                "11",
                "16",
                "15",
                "14",
                "20",
                "1",
                "45",
                "30",
                "33",
                "24",
                "36",
                "27",
                "25",
                "21",
                "23",
                "22",
                "34",
                "38",
                "10",
                "32"
            ]
        },
        {
            "codigoGrupo": "AFO",
            "codigosServicos": [
                "1",
                "2",
                "3",
                "4",
                "5",
                "6",
                "7"
            ]
        },
        {
            "codigoGrupo": "CBS",
            "codigosServicos": [
                "11"
            ]
        },
        {
            "codigoGrupo": "CCI",
            "codigosServicos": [
                "1"
            ]
        },
        {
            "codigoGrupo": "CCY",
            "codigosServicos": [
                "1",
                "2",
                "3"
            ]
        },
        {
            "codigoGrupo": "CHQ",
            "codigosServicos": [
                "10",
                "11"
            ]
        },
        {
            "codigoGrupo": "CHS",
            "codigosServicos": [
                "1",
                "2",
                "5",
                "8",
                "9",
                "10"
            ]
        },
        {
            "codigoGrupo": "CMC",
            "codigosServicos": [
                "1",
                "2",
                "3"
            ]
        },
        {
            "codigoGrupo": "CMU",
            "codigosServicos": [
                "1",
                "2",
                "3",
                "4",
                "5",
                "6",
                "7",
                "8"
            ]
        },
        {
            "codigoGrupo": "CNF",
            "codigosServicos": [
                "1",
                "2",
                "3",
                "4",
                "5"
            ]
        },
        {
            "codigoGrupo": "COB",
            "codigosServicos": [
                "1",
                "2",
                "3",
                "4",
                "6",
                "9",
                "11",
                "13",
                "14",
                "15",
                "16",
                "17",
                "18",
                "22",
                "23",
                "24",
                "26",
                "29",
                "30",
                "25",
                "7",
                "5",
                "32",
                "8"
            ]
        },
        {
            "codigoGrupo": "CON",
            "codigosServicos": [
                "1",
                "2"
            ]
        },
        {
            "codigoGrupo": "CPR",
            "codigosServicos": [
                "1",
                "2"
            ]
        },
        {
            "codigoGrupo": "CRC",
            "codigosServicos": [
                "1",
                "2"
            ]
        },
        {
            "codigoGrupo": "CTO",
            "codigosServicos": [
                "1",
                "2",
                "4",
                "5",
                "6",
                "7",
                "8"
            ]
        },
        {
            "codigoGrupo": "DDA",
            "codigosServicos": [
                "1",
                "2"
            ]
        },
        {
            "codigoGrupo": "DES",
            "codigosServicos": [
                "1",
                "2",
                "3",
                "4"
            ]
        },
        {
            "codigoGrupo": "EMC",
            "codigosServicos": [
                "1",
                "2",
                "3"
            ]
        },
        {
            "codigoGrupo": "FRA",
            "codigosServicos": [
                "1",
                "2",
                "3",
                "4"
            ]
        },
        {
            "codigoGrupo": "FXG",
            "codigosServicos": [
                "2",
                "3",
                "4"
            ]
        },
        {
            "codigoGrupo": "GDM",
            "codigosServicos": [
                "1",
                "2",
                "3",
                "4"
            ]
        },
        {
            "codigoGrupo": "GOJ",
            "codigosServicos": [
                "1"
            ]
        },
        {
            "codigoGrupo": "HBE",
            "codigosServicos": [
                "1",
                "2"
            ]
        },
        {
            "codigoGrupo": "JSA",
            "codigosServicos": [
                "8"
            ]
        },
        {
            "codigoGrupo": "MNT",
            "codigosServicos": [
                "1"
            ]
        },
        {
            "codigoGrupo": "NCS",
            "codigosServicos": [
                "1",
                "2",
                "4"
            ]
        },
        {
            "codigoGrupo": "OPB",
            "codigosServicos": [
                "1",
                "2"
            ]
        },
        {
            "codigoGrupo": "SNM",
            "codigosServicos": [
                "1"
            ]
        },
        {
            "codigoGrupo": "SEG",
            "codigosServicos": [
                "8",
                "7"
            ]
        },
        {
            "codigoGrupo": "RCC",
            "codigosServicos": [
                "1",
                "4",
                "5"
            ]
        },
        {
            "codigoGrupo": "REP",
            "codigosServicos": [
                "1",
                "2"
            ]
        },
        {
            "codigoGrupo": "SAD",
            "codigosServicos": [
                "1",
                "2",
                "3",
                "10",
                "20"
            ]
        },
        {
            "codigoGrupo": "SGA",
            "codigosServicos": [
                "1",
                "2",
                "3",
                "4",
                "5"
            ]
        },
        {
            "codigoGrupo": "SNA",
            "codigosServicos": [
                "1",
                "2",
                "4"
            ]
        },
        {
            "codigoGrupo": "SNS",
            "codigosServicos": [
                "1"
            ]
        },
        {
            "codigoGrupo": "SPA",
            "codigosServicos": [
                "1",
                "2",
                "3",
                "4",
                "5",
                "8",
                "9",
                "10",
                "13",
                "14",
                "15",
                "16",
                "17",
                "18",
                "19",
                "20",
                "21",
                "22"
            ]
        },
        {
            "codigoGrupo": "SRV",
            "codigosServicos": [
                "3",
                "4",
                "5",
                "6"
            ]
        },
        {
            "codigoGrupo": "TAC",
            "codigosServicos": [
                "1",
                "2",
                "3",
                "4",
                "5",
                "6",
                "8",
                "706"
            ]
        },
        {
            "codigoGrupo": "TER",
            "codigosServicos": [
                "1"
            ]
        },
        {
            "codigoGrupo": "TKN",
            "codigosServicos": [
                "1",
                "5",
                "6"
            ]
        },
        {
            "codigoGrupo": "VDO",
            "codigosServicos": [
                "1",
                "2"
            ]
        },
        {
            "codigoGrupo": "SQE",
            "codigosServicos": [
                "3",
                "4",
                "1",
                "5",
                "2",
                "6"
            ]
        },
        {
            "codigoGrupo": "NMR",
            "codigosServicos": [
                "1"
            ]
        },
        {
            "codigoGrupo": "POR",
            "codigosServicos": [
                "3",
                "1",
                "2"
            ]
        }
    ]
}
var conta= {
    "codigoCliente": 6272980,
    "baseDocumento": "028408806",
    "agencia": "09700",
    "agenciaCadastroBacen": "0097",
    "conta": "000293941",
    "contaCorrenteSPD": false,
    "canal": "IPJ",
    "shortname": "CARLA REGIN 284",
    "usuario": "TIAGO R",
    "codigoSegmento": 20,
    "nivel": "MASTER AUTORIZADOR",
    "nomeEmpresa": "CARLA REGINA C O 13471606807                                     ",
    "tipoPessoa": "PJ",
    "doc": "28408806000132",
    "nomeCompleto": "TIAGO RIBEIRO DOS SANTOS",
    "primeiroNome": "Tiago",
    "filaGerente": "BEAMONT",
    "segmentoGerente": "emp1"
}
var listaPermissoes = {
    "SQE": {
        "1": [
            "consultaCartoes",
            "alteracaoDeLimite"
        ],
        "4": [
            "bloqueioDeCartao",
            "perdaERoubo"
        ],
        "5": [
            "desbloqueioDeCartao",
            "desbloquear"
        ],
        "6": [
            "novaViaSenhaDeCartao",
            "bloquearEReemitir"
        ]
    },
    "CMU": {
        "2": [
            "desbloqueioDeCartao"
        ],
        "4": [
            "bloqueioDeCartao",
            "bloquearEReemitir",
            "perdaERoubo"
        ],
        "5": [
            "desbloquear"
        ],
        "7": [
            "fatura"
        ]
    },
    "CPR": {
        "3": [
            "consLimiteCredito",
            "limiteDisponivel",
            "consultaMeusLimites"
        ]
    },
    "POS": {
        "3": [
            "consLimiteCredito",
            "limiteDisponivel",
            "consultaMeusLimites"
        ],
        "4": [
            "extratoDeContaCorrente"
        ],
        "5": [
            "consultarPacoteServico",
            "pacotesDeServicos"
        ],
        "23": [
            "limitesDeCreditos"
        ]
    },
    "SPA": {
        "1": [
            "extratoSafrapay",
            "extratoSafrapayDaMaquina",
            "naoRecebiAVenda"
        ],
        "2": [
            "solicitarAntecipAuto",
            "habilitarAntecipAutomatica",
            "alterarAntecipAutomatica",
            "cancelarAntecipAutomatica"
        ],
        "3": [
            "consultOperAutomatica",
            "habilitarAntecipAutomatica",
            "alterarAntecipAutomatica",
            "cancelarAntecipAutomatica"
        ],
        "4": [
            "solicAntecipEvent",
            "habilitarAntecipEventual"
        ],
        "5": [
            "consultarCompromissos",
            "habilitarAntecipEventual"
        ],
        "6": [
            "novoExtratoSafrapay",
            "extratoSafrapayDaMaquina",
            "naoRecebiAVenda"
        ],
        "17": [
            "solicCancelDeVendas"
        ],
        "18": [
            "consultCancelDeVendas"
        ],
        "21": [
            "simuladorSafrapay",
            "simularFaturamentoAtual"
        ]
    },
    "GDM": {
        "2": [
            "desinstalacao"
        ],
        "3": [
            "consultaSolicitacao",
            "consultarOS",
            "consultaDeProtocolo"
        ]
    },
    "AFO": {
        "1": [
            "consultaAntecipFornec",
            "taxaDeAntecipacao"
        ]
    },
    "PAG": {
        "6": [
            "inclusaoDeCompromissos",
            "transferencias",
            "pagamentosESaques"
        ],
        "7": [
            "autorizacaoCompromissos",
            "transferencias",
            "pagamentosESaques"
        ],
        "9": [
            "consultaCadForneced"
        ],
        "44": [
            "transferenciaPix"
        ],
        "48": [
            "minhasChavesPix",
            "consultarChaves"
        ],
        "51": [
            "consultaLancamentoPix"
        ]
    },
    "CRE": {
        "1": [
            "contaGarantida",
            "consultarSaldoDevedor",
            "valorDisponivel"
        ]
    },
    "COB": {
        "32": [
            "boletosComQrcodePix"
        ]
    },
    "NCL": {
        "1": [
            "cadastroCelular",
            "alteracaoDeTelefoneECelular"
        ]
    }
}

function run(bodyPermissoes, contaSelecionada, listaPermissoes, perfilamentoAtivo) {
    try {
        let parsedBodyPermissoes = JSON.parse(bodyPermissoes);
        let parsedListaPermissoes = JSON.parse(listaPermissoes);
        let nivel = JSON.parse(contaSelecionada).nivel.toUpperCase();
        let permissoes = [];
        if (nivel.includes('MASTER') || perfilamentoAtivo == false) {
            Object.values(parsedListaPermissoes).forEach(grupo =>
                Object.values(grupo).forEach(perm =>
                    permissoes.push(...perm)
                )
            );
            return [...new Set(permissoes.sort((a, b) => a.localeCompare(b)))]
        }
        parsedBodyPermissoes.data.forEach(({ codigoGrupo, codigosServicos }) => {
            if (parsedListaPermissoes[codigoGrupo]) {
                codigosServicos.forEach(codigoServico => {
                    let permissoesGrupo = parsedListaPermissoes[codigoGrupo][codigoServico];
                    if (permissoesGrupo) {
                        permissoes.push(...permissoesGrupo);
                    }
                });
            }
        });
        return [...new Set(permissoes.sort((a, b) => a.localeCompare(b)))]
    } catch (err) {
        return { error: err.message };
    }
}

console.log(run(JSON.stringify(bodyPermissoes), JSON.stringify(conta), JSON.stringify(listaPermissoes), true));